<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="style/app.css">
    <title>Bootstrap 101 Template</title>
  </head>
  <body>
    <div class="container">
      <div class="row row-title">
        <div class="col-xs-12 text-center">
          <h1 class="text-primary">Tic Tac Joe</h1>
        </div>
      </div>
      <div id="game-container">
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.1.0/react-with-addons.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.1.0/react-dom.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.0.0.min.js"></script>
    <script type="text/babel">
     var GameSettingsFirstStep = React.createClass({
       clickHandler : function(level) {
         ReactDOM.render(<GameSettingsSecondStep level={level} />, document.getElementById("game-container"));
       },

       render : function() {
         return (
           <div className="row">
             <div className="row row-title">
               <div className="col-xs-12 text-center">
                 <h2>Choose the Difficulty</h2>
               </div>
             </div>
             <div className="row">
               <div className="col-xs-12 text-center">
                 <div className="btn-group btn-group-lg" role="group" aria-label="...">
                   <button type="button" className="btn btn-default" onClick={this.clickHandler.bind(this, "easy")}>Piece of Cake</button>
                   <button type="button" className="btn btn-warning" onClick={this.clickHandler.bind(this, "normal")}>Normal</button>
                   <button type="button" className="btn btn-danger" onClick={this.clickHandler.bind(this, "hard")}>Impossible</button>
                 </div>
               </div>
             </div>
           </div>
         );
       }
     });

     var GameSettingsSecondStep = React.createClass({
       clickHandler : function(mark) {
         ReactDOM.render(<GameSettingsThirdStep level={this.props.level} playerMark={mark} />, document.getElementById("game-container"));
       },

       render : function() {
         return (
           <div className="row">
             <div className="row row-title">
               <div className="col-xs-12 text-center">
                 <h2>OK! Now choose your Piece</h2>
               </div>
             </div>
             <div className="row">
               <div className="col-xs-12 text-center">
                 <div className="btn-group btn-group-lg" role="group" aria-label="...">
                   <button type="button" className="btn btn-success" onClick={this.clickHandler.bind(this, "O")}>&nbsp;&nbsp;O&nbsp;&nbsp;</button>
                   <button type="button" className="btn btn-primary" onClick={this.clickHandler.bind(this, "X")}>&nbsp;&nbsp;X&nbsp;&nbsp;</button>
                 </div>
               </div>
             </div>
           </div>
         );
       }
     });

     var GameSettingsThirdStep = React.createClass({
         clickHandler : function(whoStarts) {
           var onSuccess = function(result) {
           ReactDOM.render(<NewGame gameId={result.gameId} positions={result.positions} playerMark={result.playerMark} opponentMark={result.opponentMark} />, document.getElementById("game-container"));
           };

           var onError = function(jqXHR, textStatus, errorThrown) {
             console.log(jqXHR);
           };

           var formdata = {
             "level" : this.props.level,
             "playerMark" : this.props.playerMark,
             "whoStarts" : whoStarts
           };

           $.get({url: "http://localhost:8080/game/new", data: formdata, dataType: "json"})
            .done(onSuccess)
            .fail(onError);
       },

       render : function() {
         return (
           <div className="row">
             <div className="row row-title">
               <div className="col-xs-12 text-center">
                 <h2>Great! Who will Start?</h2>
               </div>
             </div>
             <div className="row">
               <div className="col-xs-12 text-center">
                 <div className="btn-group btn-group-lg" role="group" aria-label="...">
                   <button type="button" className="btn btn-success" onClick={this.clickHandler.bind(this, "Computer")}>Computer.</button>
                   <button type="button" className="btn btn-primary" onClick={this.clickHandler.bind(this, "You")}>I'll Start!</button>
                 </div>
               </div>
             </div>
           </div>
         );
       }
     });

           /* var BoardColumns = React.createClass({
           *   render: function() {
           *     var row = this.props.row;

           *     {this.props.columns.map(function(col) {
           *       return  <td className="text-center">
             *                 <div onClick={this.clickHandler.bind(this, 0, 0)} onMouseOver={this.hoverHandler.bind(this, 0, 0)} className={this.classHandler(0, 0)}>
             *           {this.props.positions[0][0]}
             *         </div>
             *       </td>

           *     })}
           * });*/
           
    var NewGame = React.createClass({

       isPositionAvailable : function(row, col) {
         return this.props.playerMark !== this.props.positions[row][col] &&
                this.props.opponentMark !== this.props.positions[row][col];
       },

       classHandler : function(row, col) {
          if (this.props.positions[row][col] === this.props.opponentMark) return "piece piece-opponent";
          else if (this.props.positions[row][col] === this.props.playerMark) return "piece piece-player";
          else return "piece piece-free";
       },

       hoverHandler : function(row, col) {
         if (this.isPositionAvailable(row, col)) $("#r" + row + "-c" + col + " div").text(this.props.playerMark);
       },

       clickHandler : function(row, col) {
         if (!this.isPositionAvailable(row, col)) return false;

         var onSuccess = function(result) {
           console.log(result);
           ReactDOM.render(<NewGame gameId={result.gameId} positions={result.positions} playerMark={result.playerMark} opponentMark={result.opponentMark} />,
                           document.getElementById("game-container"));
         };

         var onError = function(jqXHR, textStatus, errorThrown) {
           alert(textStatus);
         };

         var formdata = {"row":row, "col":col, "gameId":this.props.gameId};

         $.get({url: "http://localhost:8080/game/move", data: formdata, dataType: "json"})
          .done(onSuccess)
          .fail(onError);
       },

       render : function() {

         var generateColumn = function(that, positions, row) {
           return positions.map(function(value, col) {
             var id = "r" + row + "-c" + col;

             return <td key={"r" + id} className="text-center">
               <div id={id} key={"d" + id} onClick={that.clickHandler.bind(that, row, col)} onMouseOver={that.hoverHandler.bind(that, row, col)} className={that.classHandler(row, col)}>
                 {value}
               </div>
             </td>;
           });
         };

         var generateRows = function(that, positions) {
           return positions.map(function(value, row) {
             return <tr key={row}>{generateColumn(that, value, row)}</tr>;
           });
         };

         return (
           <div className="row">
             <div className="row">
               <div className="col-xs-4 col-xs-offset-4">
                 <table id="board">
                   <tbody>
                     {generateRows(this, this.props.positions)}
                   </tbody>
                 </table>
               </div>
             </div>
           </div>
         );
       }
     });

     ReactDOM.render(<GameSettingsFirstStep />, document.getElementById("game-container"));
    </script>
  </body>
</html>
